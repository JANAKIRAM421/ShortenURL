<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TinyLink - URL Shortener & Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#D53369',
            secondary: '#DAAE51',
            accent: '#43CEA2',
            gradient1: '#D53369',
            gradient2: '#43CEA2',
            gradient3: '#F8FFAE',
            gradient4: '#DAAE51'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen flex items-center justify-center" style="background: linear-gradient(120deg,#D53369,#43CEA2 60%, #F8FFAE 100%);">
  <div class="bg-white shadow-2xl rounded-2xl p-10 max-w-2xl w-full border-2 border-gradient-to-r from-primary via-accent to-gradient4">
    <h1 class="text-4xl font-extrabold text-primary mb-6 text-center drop-shadow-xl font-sans tracking-wider">TinyLink</h1>
    <form id="shorten-form">
      <input 
        type="text" 
        id="url" 
        placeholder="Enter your long URL..." 
        class="w-full p-3 border-2 border-gradient-to-r from-gradient3 via-gradient2 to-gradient4 rounded-lg focus:outline-none focus:border-primary mb-2 bg-gradient-to-r from-gradient3 via-white to-gradient1"
      />
      <input 
        type="text" 
        id="code"
        placeholder="Custom code (optional)" 
        class="w-full p-3 border-2 border-gradient-to-r from-gradient4 via-gradient1 to-gradient2 rounded-lg mb-4 bg-gradient-to-r from-gradient2 via-white to-gradient4"
      />
      <button 
        type="submit" 
        class="bg-gradient-to-r from-primary via-accent to-secondary text-white py-2 px-6 rounded-lg font-bold hover:from-gradient4 hover:via-gradient1 hover:to-gradient2 shadow-lg transition duration-150 w-full tracking-wide"
      >
        Shorten URL
      </button>
      <div id="error" class="text-red-500 mt-2 text-center"></div>
      <div id="success" class="text-green-500 mt-2 text-center font-medium"></div>
    </form>
    <div class="flex flex-col sm:flex-row gap-2 mt-6 mb-2">
      <input type="text" id="filterCode" placeholder="Filter by code..." class="p-2 border rounded w-full sm:w-1/2 bg-gradient-to-r from-gradient3 via-white to-gradient1" />
      <input type="text" id="filterURL" placeholder="Filter by URL..." class="p-2 border rounded w-full sm:w-1/2 bg-gradient-to-r from-gradient2 via-white to-gradient4" />
    </div>
    <div id="dashboard" class="overflow-x-auto"></div>
  </div>

  <!-- Spinner -->
  <div id="spinner" class="fixed inset-0 bg-gray-900 bg-opacity-40 flex items-center justify-center hidden z-10">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-primary"></div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden z-20">
    <div class="bg-white rounded-lg shadow-xl p-6">
      <p class="text-lg mb-4 text-primary font-semibold">Are you sure you want to delete this link?</p>
      <button id="modalConfirm" class="bg-primary text-white px-4 py-2 rounded mr-2 font-semibold hover:bg-gradient2">Delete</button>
      <button id="modalCancel" class="bg-gradient-to-r from-gradient3 to-gradient4 px-4 py-2 rounded font-semibold border border-primary">Cancel</button>
    </div>
  </div>

  <script>
    let sortField = '';
    let sortAsc = true;
    let pendingDeleteCode = null;

    function showSpinner() { document.getElementById('spinner').classList.remove('hidden'); }
    function hideSpinner() { document.getElementById('spinner').classList.add('hidden'); }

    async function refreshDashboardSorted() {
      showSpinner();
      const res = await fetch('/api/links');
      let links = await res.json();
      // Filter
      const codeValue = document.getElementById('filterCode').value.toLowerCase();
      const urlValue = document.getElementById('filterURL').value.toLowerCase();
      links = links.filter(link =>
        link.code.toLowerCase().includes(codeValue) &&
        link.url.toLowerCase().includes(urlValue)
      );
      // Sort
      if (sortField) {
        links.sort((a, b) => {
          let va = a[sortField] || '';
          let vb = b[sortField] || '';
          if (sortField === 'lastClicked') {
            va = new Date(va || 0);
            vb = new Date(vb || 0);
          }
          if (va < vb) return sortAsc ? -1 : 1;
          if (va > vb) return sortAsc ? 1 : -1;
          return 0;
        });
      }
      // Table
      let html = `
        <table class="w-full mt-2 text-sm">
          <tr class="bg-gradient-to-r from-gradient3 via-gradient1 to-gradient4 font-semibold">
            <td>
              <button type="button" onclick="sortTable('code')" class="underline text-primary">Code</button>
            </td>
            <td>
              <button type="button" onclick="sortTable('url')" class="underline text-primary">URL</button>
            </td>
            <td>
              <button type="button" onclick="sortTable('clicks')" class="underline text-primary">Clicks</button>
            </td>
            <td>
              <button type="button" onclick="sortTable('lastClicked')" class="underline text-primary">Last Clicked</button>
            </td>
            <td class="text-right">Actions</td>
          </tr>
          ${links.map(link => `
            <tr class="hover:bg-gradient-to-r from-gradient3 via-gradient4 to-gradient2 transition">
              <td>
                <a href="/${link.code}" target="_blank" class="text-primary underline font-bold hover:text-gradient2 transition">${link.code}</a>
                <button type="button" onclick="copyLink('${link.code}')" class="ml-2 text-xs px-2 py-1 rounded bg-accent text-white hover:bg-gradient1 font-semibold">Copy</button>
              </td>
              <td class="truncate max-w-xs" title="${link.url}"><span class="block text-secondary">${link.url}</span></td>
              <td class="font-bold text-gradient2">${link.clicks}</td>
              <td>${link.lastClicked ? new Date(link.lastClicked).toLocaleString() : '-'}</td>
              <td class="text-right">
                <button type="button" onclick="deleteLink('${link.code}')" class="bg-primary text-white px-3 py-1 rounded font-semibold shadow-sm hover:bg-gradient2 transition">Delete</button>
                <a href="/code/${link.code}" class="ml-3 text-accent underline font-bold">Stats</a>
              </td>
            </tr>
          `).join('')}
        </table>
      `;
      document.getElementById('dashboard').innerHTML = html;
      hideSpinner();
    }

    function sortTable(field) {
      sortAsc = (sortField === field) ? !sortAsc : true;
      sortField = field;
      refreshDashboardSorted();
    }

    document.getElementById('filterCode').addEventListener('input', refreshDashboardSorted);
    document.getElementById('filterURL').addEventListener('input', refreshDashboardSorted);

    function copyLink(code) {
      const shortUrl = `${window.location.origin}/${code}`;
      navigator.clipboard.writeText(shortUrl);
      document.getElementById('success').textContent = "Copied to clipboard: " + shortUrl;
      setTimeout(() => {
        document.getElementById('success').textContent = "";
      }, 2000);
    }

    function deleteLink(code) {
      pendingDeleteCode = code;
      document.getElementById('modal').classList.remove('hidden');
    }
    document.getElementById('modalConfirm').onclick = async function() {
      showSpinner();
      await fetch(`/api/links/${pendingDeleteCode}`, { method: 'DELETE' });
      document.getElementById('modal').classList.add('hidden');
      pendingDeleteCode = null;
      hideSpinner();
      refreshDashboardSorted();
    };
    document.getElementById('modalCancel').onclick = function() {
      document.getElementById('modal').classList.add('hidden');
      pendingDeleteCode = null;
    };

    document.getElementById('shorten-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      document.getElementById('error').textContent = "";
      document.getElementById('success').textContent = "";
      const url = document.getElementById('url').value;
      const code = document.getElementById('code').value;
      if (!url) {
        document.getElementById('error').textContent = "Please enter a URL";
        return;
      }
      showSpinner();
      const res = await fetch('/api/links', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, code })
      });
      hideSpinner();
      if (res.status === 409) {
        document.getElementById('error').textContent = "Custom code is already taken!";
        return;
      }
      const data = await res.json();
      if (data.success) {
        document.getElementById('success').textContent = "Short URL: " + window.location.origin + "/" + data.code;
        refreshDashboardSorted();
      } else {
        document.getElementById('error').textContent = data.message || "Failed to shorten URL";
      }
    });

    refreshDashboardSorted();
  </script>
</body>
</html>
